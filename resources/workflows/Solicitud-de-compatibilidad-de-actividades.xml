<?xml version="1.0"?>

<workflow-definition
		xmlns="urn:liferay.com:liferay-workflow_7.4.0"
		xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
		xsi:schemaLocation="urn:liferay.com:liferay-workflow_7.4.0 http://www.liferay.com/dtd/liferay-workflow-definition_7_4_0.xsd"
>
	<name>3919e0dd-3d12-1ebb-eedb-cb1d09bcc345</name>
	<version>9</version>
	<state>
		<name>InicioCreacionSolicitud</name>
		<description>Inicia un flujo de trabajo.</description>
		<metadata>
			<![CDATA[
				{
					"xy": [
						-309.29319956507396,
						168.61442898491455
					]
				}
			]]>
		</metadata>
		<initial>true</initial>
		<labels>
			<label language-id="es_ES">
				Creación solicitud compatbilidad
			</label>
		</labels>
		<transitions>
			<transition>
				<labels>
					<label language-id="es_ES">
						Enviada solicitud de compatibilidades
					</label>
				</labels>
				<name>bbe4da74-616c-468a-9429-c37938655e90</name>
				<target>Asignar-admin-RRHH</target>
				<default>true</default>
			</transition>
		</transitions>
	</state>
	<state>
		<name>03ce737b-c013-484b-bddb-138fda31cc7a</name>
		<description>Finaliza el flujo de trabajo.</description>
		<metadata>
			<![CDATA[
				{
					"xy": [
						739.9144180451676,
						1325.8016139632946
					],
					"terminal": true
				}
			]]>
		</metadata>
		<actions>
			<notification>
				<name>Se ha creado una nueva solicitud de compatibilidad</name>
				<description>
					<![CDATA[]]>
				</description>
				<template>
					<![CDATA[Se ha creado una nueva solicitud de compatibilidad]]>
				</template>
				<template-language>text</template-language>
				<notification-type>user-notification</notification-type>
				<recipients receptionType="to">
					<roles>
						<role>
							<role-id>35183</role-id>
						</role>
					</roles>
				</recipients>
				<execution-type>onEntry</execution-type>
			</notification>
		</actions>
		<labels>
			<label language-id="es_ES">
				Fin proceso solicitud
			</label>
		</labels>
	</state>
	<state>
		<name>Rechazada-guardada-SIGD</name>
		<description>Finaliza el flujo de trabajo.</description>
		<metadata>
			<![CDATA[
				{
					"xy": [
						240.6763916015625,
						-103.29939270019531
					],
					"terminal": true
				}
			]]>
		</metadata>
		<actions>
			<action>
				<name>Estado workflow</name>
				<description></description>
				<status>4</status>
				<priority>1</priority>
				<execution-type>onEntry</execution-type>
			</action>
			<action>
				<name>Guardar en SIGD y cambiar estado objecto</name>
				<description></description>
				<script>
					<![CDATA[import com.liferay.portal.template.*;
import com.liferay.portal.util.*;
import org.osgi.framework.Bundle;
import org.osgi.framework.FrameworkUtil;
import org.osgi.util.tracker.ServiceTracker;
import es.emasesa.intranet.base.util.CustomWorkflowUtil;
import es.emasesa.intranet.sigd.service.application.SigdServiceApplication;

Bundle bundleWorkflow = FrameworkUtil.getBundle(CustomWorkflowUtil.class);
ServiceTracker customWorkflowUtilTracker = new ServiceTracker(bundleWorkflow.getBundleContext(),CustomWorkflowUtil.class, null);
customWorkflowUtilTracker.open();
CustomWorkflowUtil customWorkflowUtil = customWorkflowUtilTracker.getService();

Bundle bundleSigd = FrameworkUtil.getBundle(SigdServiceApplication.class);
ServiceTracker sigdServiceTracker = new ServiceTracker(bundleSigd.getBundleContext(),SigdServiceApplication.class, null);
sigdServiceTracker.open();
SigdServiceApplication sigdService = sigdServiceTracker.getService();

customWorkflowUtil.updateObjectHistoryAndStatus(workflowContext, "rechazada", userId, "Administrador RRHH");
//Subir el object en PDF
String pdf = customWorkflowUtil.pdfBase64(customWorkflowUtil.createPDF(workflowContext));
if(pdf != null && pdf != ""){
	String idDocumentoSigd = sigdService.saveDocumentOnSIGD(pdf, "Compatibilidad", "solicitud");
}
//Subir fichero certificacion o decalracion responsable
String pdfCuentaPropia = customWorkflowUtil.getDocumentToLoad(workflowContext, "certificacionDeLaEmpresa");
String pdfCuentaAjena = customWorkflowUtil.getDocumentToLoad(workflowContext, "declaracionResponsable");

if(pdfCuentaPropia != null && pdfCuentaPropia != ""){
	String idDocumentoCuentaPropiaSigd = sigdService.saveDocumentOnSIGD(pdfCuentaPropia, "Compatibilidad", "solicitud");
}else if(pdfCuentaAjena != null && pdfCuentaAjena != ""){
	String idDocumentoCuentaAjenaSigd = sigdService.saveDocumentOnSIGD(pdfCuentaAjena, "Compatibilidad", "solicitud");
}

customWorkflowUtilTracker.close();
sigdServiceTracker.close();
]]>
				</script>
				<script-language>groovy</script-language>
				<priority>1</priority>
				<execution-type>onEntry</execution-type>
			</action>
			<notification>
				<name>Notificar al usaurio</name>
				<description>
					<![CDATA[]]>
				</description>
				<template>
					<![CDATA[Su solicitud ha sido denegada]]>
				</template>
				<template-language>text</template-language>
				<notification-type>user-notification</notification-type>
				<recipients receptionType="to">
					<user />
				</recipients>
				<execution-type>onEntry</execution-type>
			</notification>
		</actions>
		<labels>
			<label language-id="es_ES">
				Rechazada y guardada en SIGD
			</label>
		</labels>
	</state>
	<state>
		<name>aceptar-solicitud</name>
		<description>Ejecuta las acciones en el flujo de trabajo.</description>
		<metadata>
			<![CDATA[
				{
					"xy": [
						529.1366832212416,
						994.9496702729289
					]
				}
			]]>
		</metadata>
		<actions>
			<action>
				<name>Cambiar estado workflow</name>
				<description></description>
				<status>0</status>
				<priority>1</priority>
				<execution-type>onEntry</execution-type>
			</action>
			<action>
				<name>Cambiar estado objecto</name>
				<description></description>
				<script>
					<![CDATA[import com.liferay.portal.template.*;
import com.liferay.portal.util.*;
import org.osgi.framework.Bundle;
import org.osgi.framework.FrameworkUtil;
import org.osgi.util.tracker.ServiceTracker;
import es.emasesa.intranet.base.util.CustomWorkflowUtil;

Bundle bundle = FrameworkUtil.getBundle(CustomWorkflowUtil.class);
ServiceTracker customWorkflowUtilTracker = new ServiceTracker(bundle.getBundleContext(),CustomWorkflowUtil.class, null);

customWorkflowUtilTracker.open();
CustomWorkflowUtil customWorkflowUtil = customWorkflowUtilTracker.getService();
customWorkflowUtil.updateObjectHistoryAndStatus(workflowContext, "aceptada", userId, "Administrador RRHH");
customWorkflowUtilTracker.close();]]>
				</script>
				<script-language>groovy</script-language>
				<priority>1</priority>
				<execution-type>onEntry</execution-type>
			</action>
			<notification>
				<name>Solicitud aceptada</name>
				<description>
					<![CDATA[]]>
				</description>
				<template>
					<![CDATA[La solicitud de compatibilidad de actividades ha sido aceptada]]>
				</template>
				<template-language>text</template-language>
				<notification-type>user-notification</notification-type>
				<recipients receptionType="to">
					<user />
				</recipients>
				<execution-type>onEntry</execution-type>
			</notification>
		</actions>
		<labels>
			<label language-id="es_ES">
				Solicitud aceptada
			</label>
		</labels>
		<transitions>
			<transition>
				<labels>
					<label language-id="es_ES">
						Fin del proceso solicitud aceptada
					</label>
				</labels>
				<name>772540d0-247a-45f3-aa8c-4e7ae4042c2b</name>
				<target>03ce737b-c013-484b-bddb-138fda31cc7a</target>
				<default>true</default>
			</transition>
		</transitions>
	</state>
	<state>
		<name>rechazar-solicitud</name>
		<description>Ejecuta las acciones en el flujo de trabajo.</description>
		<metadata>
			<![CDATA[
				{
					"xy": [
						950.3536376953125,
						993.8009643554688
					]
				}
			]]>
		</metadata>
		<actions>
			<action>
				<name>Cambiar estado workflow</name>
				<description></description>
				<status>4</status>
				<priority>1</priority>
				<execution-type>onEntry</execution-type>
			</action>
			<action>
				<name>Cambiar estado objeto</name>
				<description></description>
				<script>
					<![CDATA[import com.liferay.portal.template.*;
import com.liferay.portal.util.*;
import org.osgi.framework.Bundle;
import org.osgi.framework.FrameworkUtil;
import org.osgi.util.tracker.ServiceTracker;
import es.emasesa.intranet.base.util.CustomWorkflowUtil;

Bundle bundle = FrameworkUtil.getBundle(CustomWorkflowUtil.class);
ServiceTracker customWorkflowUtilTracker = new ServiceTracker(bundle.getBundleContext(),CustomWorkflowUtil.class, null);

customWorkflowUtilTracker.open();
CustomWorkflowUtil customWorkflowUtil = customWorkflowUtilTracker.getService();
customWorkflowUtil.updateObjectHistoryAndStatus(workflowContext, "rechazada", userId, "Administrador RRHH");
customWorkflowUtilTracker.close();]]>
				</script>
				<script-language>groovy</script-language>
				<priority>1</priority>
				<execution-type>onEntry</execution-type>
			</action>
			<notification>
				<name>Solicitud rechazada</name>
				<description>
					<![CDATA[]]>
				</description>
				<template>
					<![CDATA[La solicitud de compatibilidad de actividades ha sido rechazada]]>
				</template>
				<template-language>text</template-language>
				<notification-type>user-notification</notification-type>
				<recipients receptionType="to">
					<user />
				</recipients>
				<execution-type>onEntry</execution-type>
			</notification>
		</actions>
		<labels>
			<label language-id="es_ES">
				Solicitud rechazada
			</label>
		</labels>
		<transitions>
			<transition>
				<labels>
					<label language-id="es_ES">
						Fin del proceso solicitud rechazada
					</label>
				</labels>
				<name>525106a5-b369-4f3e-bb16-08376dc059ac</name>
				<target>03ce737b-c013-484b-bddb-138fda31cc7a</target>
				<default>true</default>
			</transition>
		</transitions>
	</state>
	<task>
		<name>Asignar-admin-RRHH</name>
		<description>Pida a un usuario que trabaje en el elemento.</description>
		<metadata>
			<![CDATA[
				{
					"xy": [
						239.89244673721592,
						173.5671556788145
					]
				}
			]]>
		</metadata>
		<actions>
			<action>
				<name>Cambiar estado objeto</name>
				<description></description>
				<script>
					<![CDATA[import com.liferay.portal.template.*;
import com.liferay.portal.util.*;
import org.osgi.framework.Bundle;
import org.osgi.framework.FrameworkUtil;
import org.osgi.util.tracker.ServiceTracker;
import es.emasesa.intranet.base.util.CustomWorkflowUtil;

Bundle bundle = FrameworkUtil.getBundle(CustomWorkflowUtil.class);
ServiceTracker customWorkflowUtilTracker = new ServiceTracker(bundle.getBundleContext(),CustomWorkflowUtil.class, null);

customWorkflowUtilTracker.open();
CustomWorkflowUtil customWorkflowUtil = customWorkflowUtilTracker.getService();
customWorkflowUtil.updateObjectHistoryAndStatus(workflowContext, "pendienteDeAdministracionDeRRHH", userId, "Administrador RRHH");
customWorkflowUtilTracker.close();]]>
				</script>
				<script-language>groovy</script-language>
				<priority>1</priority>
				<execution-type>onExit</execution-type>
			</action>
			<action>
				<name>Cambiar estado workflow</name>
				<description></description>
				<status>1</status>
				<priority>1</priority>
				<execution-type>onEntry</execution-type>
			</action>
			<notification>
				<name>Creación solicitud</name>
				<description>
					<![CDATA[]]>
				</description>
				<template>
					<![CDATA[Se ha creado una nueva solicitud de RRHH]]>
				</template>
				<template-language>text</template-language>
				<notification-type>user-notification</notification-type>
				<recipients receptionType="to">
					<roles>
						<role>
							<role-id>35183</role-id>
						</role>
					</roles>
				</recipients>
				<execution-type>onEntry</execution-type>
			</notification>
		</actions>
		<assignments>
			<roles>
				<role>
					<role-id>35183</role-id>
				</role>
			</roles>
		</assignments>
		<labels>
			<label language-id="es_ES">
				Administración RRHH
			</label>
		</labels>
		<transitions>
			<transition>
				<labels>
					<label language-id="es_ES">
						Solicitud aprobada
					</label>
				</labels>
				<name>Aprobada-enviar-asesor-juridico</name>
				<target>Asignar-asesoria-juridica</target>
				<default>true</default>
			</transition>
			<transition>
				<labels>
					<label language-id="es_ES">
						Rechazar y guardada en SIGD
					</label>
				</labels>
				<name>Rechazar-y-guardar-en-sigd</name>
				<target>Rechazada-guardada-SIGD</target>
				<default>false</default>
			</transition>
			<transition>
				<labels>
					<label language-id="es_ES">
						Devuelta para edición
					</label>
				</labels>
				<name>Devolver-a-usuario-para-edicion</name>
				<target>Devolver-solicitud</target>
				<default>false</default>
			</transition>
		</transitions>
	</task>
	<task>
		<name>Asignar-asesoria-juridica</name>
		<description>Pida a un usuario que trabaje en el elemento.</description>
		<metadata>
			<![CDATA[
				{
					"xy": [
						709.4450880245005,
						181.44353567969696
					]
				}
			]]>
		</metadata>
		<actions>
			<action>
				<name>Cambiar estado objecto</name>
				<description></description>
				<script>
					<![CDATA[import com.liferay.portal.template.*;
import com.liferay.portal.util.*;
import org.osgi.framework.Bundle;
import org.osgi.framework.FrameworkUtil;
import org.osgi.util.tracker.ServiceTracker;
import es.emasesa.intranet.base.util.CustomWorkflowUtil;

Bundle bundle = FrameworkUtil.getBundle(CustomWorkflowUtil.class);
ServiceTracker customWorkflowUtilTracker = new ServiceTracker(bundle.getBundleContext(),CustomWorkflowUtil.class, null);

customWorkflowUtilTracker.open();
CustomWorkflowUtil customWorkflowUtil = customWorkflowUtilTracker.getService();
customWorkflowUtil.updateObjectHistoryAndStatus(workflowContext, "pendienteDeAsesoriaJuridica", userId, "Asesor jurídico");
customWorkflowUtilTracker.close();]]>
				</script>
				<script-language>groovy</script-language>
				<priority>1</priority>
				<execution-type>onExit</execution-type>
			</action>
			<notification>
				<name>Notificacion aceptacion RRHH</name>
				<description>
					<![CDATA[]]>
				</description>
				<template>
					<![CDATA[La solicutud ha sido aceptada por RRHH, queda pendiente de revisión por asesoría jurídica]]>
				</template>
				<template-language>text</template-language>
				<notification-type>user-notification</notification-type>
				<recipients receptionType="to">
					<roles>
						<role>
							<role-id>35185</role-id>
						</role>
					</roles>
				</recipients>
				<execution-type>onAssignment</execution-type>
			</notification>
		</actions>
		<assignments>
			<roles>
				<role>
					<role-id>35185</role-id>
				</role>
			</roles>
		</assignments>
		<labels>
			<label language-id="es_ES">
				Asesoría jurídica
			</label>
		</labels>
		<transitions>
			<transition>
				<labels>
					<label language-id="es_ES">
						Mandar a portafirmas
					</label>
				</labels>
				<name>Mandar-a-portafirmas</name>
				<target>portafirma-consejero-delegado</target>
				<default>true</default>
			</transition>
		</transitions>
	</task>
	<task>
		<name>Devolver-solicitud</name>
		<description>Pida a un usuario que trabaje en el elemento.</description>
		<metadata>
			<![CDATA[
				{
					"xy": [
						238.86638007473806,
						449.49999448810627
					]
				}
			]]>
		</metadata>
		<actions>
			<action>
				<name>Cambiar estado objeto</name>
				<description></description>
				<script>
					<![CDATA[import com.liferay.portal.template.*;
import com.liferay.portal.util.*;
import org.osgi.framework.Bundle;
import org.osgi.framework.FrameworkUtil;
import org.osgi.util.tracker.ServiceTracker;
import es.emasesa.intranet.base.util.CustomWorkflowUtil;

Bundle bundle = FrameworkUtil.getBundle(CustomWorkflowUtil.class);
ServiceTracker customWorkflowUtilTracker = new ServiceTracker(bundle.getBundleContext(),CustomWorkflowUtil.class, null);

customWorkflowUtilTracker.open();
CustomWorkflowUtil customWorkflowUtil = customWorkflowUtilTracker.getService();
customWorkflowUtil.updateObjectHistoryAndStatus(workflowContext, "pendienteSolicitante", userId, "User");
customWorkflowUtilTracker.close();]]>
				</script>
				<script-language>groovy</script-language>
				<priority>1</priority>
				<execution-type>onEntry</execution-type>
			</action>
			<notification>
				<name>Devuelta por RRHH</name>
				<description>
					<![CDATA[]]>
				</description>
				<template>
					<![CDATA[Se devuelve solicitud para revisión]]>
				</template>
				<template-language>freemarker</template-language>
				<notification-type>user-notification</notification-type>
				<recipients receptionType="to">
					<user />
				</recipients>
				<execution-type>onEntry</execution-type>
			</notification>
		</actions>
		<assignments>
			<user />
		</assignments>
		<labels>
			<label language-id="es_ES">
				Devuelta por RRHH
			</label>
		</labels>
		<transitions>
			<transition>
				<labels>
					<label language-id="es_ES">
						Devuelta a RHH
					</label>
				</labels>
				<name>Devolver-a-rrhh</name>
				<target>Asignar-admin-RRHH</target>
				<default>true</default>
			</transition>
		</transitions>
	</task>
	<task>
		<name>revision-rrhh</name>
		<description>Pida a un usuario que trabaje en el elemento.</description>
		<metadata>
			<![CDATA[
				{
					"xy": [
						703.5228438180645,
						588.0923539282425
					]
				}
			]]>
		</metadata>
		<actions>
			<action>
				<name>Cambiar estado objecto</name>
				<description></description>
				<script>
					<![CDATA[import com.liferay.portal.template.*;
import com.liferay.portal.util.*;
import org.osgi.framework.Bundle;
import org.osgi.framework.FrameworkUtil;
import org.osgi.util.tracker.ServiceTracker;
import es.emasesa.intranet.base.util.CustomWorkflowUtil;

Bundle bundle = FrameworkUtil.getBundle(CustomWorkflowUtil.class);
ServiceTracker customWorkflowUtilTracker = new ServiceTracker(bundle.getBundleContext(),CustomWorkflowUtil.class, null);

customWorkflowUtilTracker.open();
CustomWorkflowUtil customWorkflowUtil = customWorkflowUtilTracker.getService();
customWorkflowUtil.updateObjectHistoryAndStatus(workflowContext, "pendienteRevisionRRHH", userId, "Administrador RRHH");
customWorkflowUtilTracker.close();]]>
				</script>
				<script-language>groovy</script-language>
				<priority>1</priority>
				<execution-type>onExit</execution-type>
			</action>
			<notification>
				<name>Solicitud procedente de portafirmas pendiente de revisión</name>
				<description>
					<![CDATA[]]>
				</description>
				<template>
					<![CDATA[Se ha aceptado solicitud de compatibilidad por Consejero delegado y queda pendiente de revisión de RRHH]]>
				</template>
				<template-language>text</template-language>
				<notification-type>user-notification</notification-type>
				<recipients receptionType="to">
					<roles>
						<role>
							<role-id>35183</role-id>
						</role>
					</roles>
				</recipients>
				<execution-type>onEntry</execution-type>
			</notification>
		</actions>
		<assignments>
			<roles>
				<role>
					<role-id>35183</role-id>
				</role>
			</roles>
		</assignments>
		<labels>
			<label language-id="es_ES">
				Administración RRHH
			</label>
		</labels>
		<transitions>
			<transition>
				<labels>
					<label language-id="es_ES">
						Aceptar solicitud
					</label>
				</labels>
				<name>aceptar</name>
				<target>aceptar-solicitud</target>
				<default>true</default>
			</transition>
			<transition>
				<labels>
					<label language-id="es_ES">
						Rechazar Solicitud
					</label>
				</labels>
				<name>rechazar</name>
				<target>rechazar-solicitud</target>
				<default>false</default>
			</transition>
		</transitions>
	</task>
	<task>
		<name>portafirma-consejero-delegado</name>
		<description>Pida a un usuario que trabaje en el elemento.</description>
		<metadata>
			<![CDATA[
				{
					"xy": [
						712.3799674990595,
						365.9026416878472
					]
				}
			]]>
		</metadata>
		<actions>
			<action>
				<name>Enviar a portafirmas</name>
				<description></description>
				<script>
					<![CDATA[import com.liferay.portal.template.*;
import com.liferay.portal.util.*;
import org.osgi.framework.Bundle;
import org.osgi.framework.FrameworkUtil;
import org.osgi.util.tracker.ServiceTracker;
import es.emasesa.intranet.base.util.CustomWorkflowUtil;
import es.emasesa.intranet.sigd.service.application.SigdServiceApplication;

Bundle bundleWorkflow = FrameworkUtil.getBundle(CustomWorkflowUtil.class);
ServiceTracker customWorkflowUtilTracker = new ServiceTracker(bundleWorkflow.getBundleContext(),CustomWorkflowUtil.class, null);
customWorkflowUtilTracker.open();
CustomWorkflowUtil customWorkflowUtil = customWorkflowUtilTracker.getService();

Bundle bundleSigd = FrameworkUtil.getBundle(SigdServiceApplication.class);
ServiceTracker sigdServiceTracker = new ServiceTracker(bundleSigd.getBundleContext(),SigdServiceApplication.class, null);
sigdServiceTracker.open();
SigdServiceApplication sigdService = sigdServiceTracker.getService();

customWorkflowUtil.updateObjectHistoryAndStatus(workflowContext, "pendienteConsejeroDelegado", userId, "Consejero Delegado");
//Recuperar anexo introducido en el campo anterior
String pdfAnexoAsesoriaJuridica = customWorkflowUtil.getDocumentToLoad(workflowContext, "anexoAsesoriaJuridica");
if(pdfAnexoAsesoriaJuridica != null && pdfAnexoAsesoriaJuridica != ""){
	String idDocumentoCuentaAjenaSigd = sigdService.saveDocumentOnSIGD(pdfAnexoAsesoriaJuridica, "Compatibilidad", "solicitud");
}

//Subir formulario de solicitud
String pdf = customWorkflowUtil.pdfBase64(customWorkflowUtil.createPDF(workflowContext));
if(pdf != null && pdf != ""){
	String idDocumentoSigd = sigdService.saveDocumentOnSIGD(pdf, "Compatibilidad", "solicitud");
}

customWorkflowUtilTracker.close();
sigdServiceTracker.close();]]>
				</script>
				<script-language>groovy</script-language>
				<priority>1</priority>
				<execution-type>onExit</execution-type>
			</action>
		</actions>
		<assignments>
			<roles>
				<role>
					<role-id>49026</role-id>
				</role>
			</roles>
		</assignments>
		<labels>
			<label language-id="es_ES">
				Consejero delegado
			</label>
		</labels>
		<transitions>
			<transition>
				<labels>
					<label language-id="es_ES">
						Notificar a RRHH
					</label>
				</labels>
				<name>Notificar-a-rrhh</name>
				<target>revision-rrhh</target>
				<default>true</default>
			</transition>
		</transitions>
	</task>
</workflow-definition>